<!-- Load the jQuery and jQuery UI libraries. -->
<script src="https://code.jquery.com/jquery-1.8.3.min.js"></script>
<script src="https://code.jquery.com/ui/1.10.0/jquery-ui.min.js"></script>
<script>
    $(function() {
        $('#caixas-list').bind('change', onChangeCaixaSelected);
        $('#submit-caixa').bind('click', submit);
        loadSheetData()
    });

    /**
     * Variaveis globais
     * */
    let caixas = null
    let caixaSelected = null

    function loadSheetData(){
      google.script.run
        .withSuccessHandler(showCaixasList)
        .withFailureHandler(showMensagens)
        .getCaixas();
    }

    function onChangeCaixaSelected(){
      caixaSelected = $('#caixas-list').val()
      if(!caixaSelected){
        $('#submit-caixa').prop('disabled', true)
        showMensagens("Escolha uma caixa")
      } else {
        $('#submit-caixa').prop('disabled', false)
        showMensagens("")
        google.script.run
            .withSuccessHandler(showBeneficiosPorCaixa)
            .withFailureHandler(showMensagens)
            .getBeneficiosPorCaixas(caixaSelected)
      }
    }

    /**
     * Exibe a lista de caixas no select
     * @param {Array} Lista de Nbs sem arquivo atribuído
     */
    function showCaixasList(data) {
      const sheetData = JSON.parse(data)
      caixas = ['', ...sheetData]
      const select = $('#caixas-list');
      select.empty();
      caixas.forEach((caixa) => {
        let option = $('<option>')
          .attr('value', caixa)
          .text(` ${caixa}` );
        select.append(option);
      });
    }

    function showBeneficiosPorCaixa(data){
        const rowsData = JSON.parse(data)
        $('#result').empty()
        const total = (rowsData)?.length
        $('#total').html(`No total são <b>${total}</b> benefícios nesta caixa`)
        for(rowData of rowsData){
            let urlFile = rowData?.Arquivo
            let nb = rowData?.Especie + ' / ' + rowData?.Numero 
            let html = `<li><a href="${urlFile}" target="_blank">${nb}</a></li>`
            $('#result').append(html)
        }
    }

    function showMensagens(message) {
      $('#mensagens').text(message)
    }

    function submit(){
      google.script.run
        .withSuccessHandler(onSuccessSubmit)
        .withFailureHandler(showMensagens)
        .geraEtiqueta(caixaSelected)
    }

    function onSuccessSubmit(){
      showMensagens('A etiqueta foi gerada com sucesso. Para imprimir, presseione Ctrl + P e na caixa de impressão escolha Células Selecionadas.')
      google.script.host.editor.focus()
    }
    
  </script>